# 完整工作流程详解

> 版本: 3.2.0 | 最后更新: 2026-02-05

本文档详细说明海洋数据预处理的完整工作流程（Step 1-7）。

---

## Step 1-2: 收集基本信息

从用户的 prompt 中提取已有信息，追问缺失的：

| 信息 | 必需 | 如果缺失 |
|------|------|---------|
| 数据目录 | ✅ | 追问 |
| 输出目录 | ✅ | 追问 |
| 研究变量 | ⚠️ | 可以先分析数据再选 |
| 下采样倍数 | ⚠️ | Step 5 追问 |
| 插值方法 | ⚠️ | Step 5 追问 |
| 划分比例 | ⚠️ | Step 5 追问 |

**注意**：如果用户已经说了下采样倍数、方法等，先记下来，后面 Step 6 再确认。

---

## Step 3: 分析数据

**⚠️ 重要**：如果用户**没有明确指定研究变量**，必须先用 `ocean_inspect_data` 分析数据，让用户选择后再继续。**禁止猜测研究变量！**

| 用户是否指定了研究变量 | 调用工具 |
|----------------------|---------|
| ❌ 未指定 | `ocean_inspect_data`（仅分析，不处理） |
| ✅ 已指定 | `ocean_preprocess_full`（分析+等待确认） |

**用户未指定研究变量时**，调用 `ocean_inspect_data`：
```json
{
  "nc_folder": "/用户提供的数据目录"
}
```

**用户已明确指定研究变量时**，调用 `ocean_preprocess_full`：
```json
{
  "nc_folder": "/用户提供的数据目录",
  "output_base": "/用户提供的输出目录",
  "dyn_vars": ["用户明确指定的变量"]
}
```

**向用户展示分析结果示例**：
```
数据分析完成，以下是您的数据信息：

【文件信息】
- 数据目录: /data/ocean
- 文件数量: 365 个
- 数据形状: (365, 680, 1440) [时间, 高度, 宽度]

【动态变量候选】（有时间维度，可作为研究目标）
- chl: 形状 (365, 680, 1440), float32
- no3: 形状 (365, 680, 1440), float32

【疑似掩码变量】
- mask: 形状 (680, 1440), int8

【疑似静态变量】
- lon: 形状 (680, 1440)
- lat: 形状 (680, 1440)
```

---

## Step 4: 用户选择（强制停止点）

**⛔ 这是强制停止点！** Agent 必须在此处停下来，等待用户明确选择：

```
请根据以上信息确认：

1. 您要研究哪些变量？【必须由用户选择，Agent 禁止猜测】
   可选: chl, no3, temp

2. 掩码变量使用 mask 吗？（如果数据没有掩码，可以设为空）

3. 需要保存哪些静态变量？
   可选: lon, lat, h, mask

4. 数据中是否允许 NaN 值存在？
```

**Agent 禁止行为**：
- ❌ 根据变量名"推测"用户想研究什么
- ❌ 看到只有几个动态变量就自动全选
- ❌ 跳过询问直接使用检测到的变量

**Agent 必须做的**：
- ✅ 展示所有动态变量候选，明确询问"您要研究哪些变量？"
- ✅ 等待用户回复后才能继续

---

## Step 5: 追问处理参数

如果用户之前没有提供处理参数，现在追问：

```
接下来需要确认处理参数：

1. **超分数据来源方式**：
   - 下采样：从高分辨率数据下采样生成低分辨率数据
   - 数值模型：使用粗网格直接运行数值模型

2. **下采样参数**（如果选择下采样）：
   - 下采样倍数（scale）：如 4 表示尺寸缩小为 1/4
   - 插值方法：area（推荐）、cubic、linear、nearest、lanczos

3. **数据集划分比例**：
   - train/valid/test 比例？（如 0.7/0.15/0.15）

4. **数据裁剪**（可选）：
   - 是否需要裁剪以确保尺寸能被 scale 整除？
```

### 两种超分方式的处理区别

| 方式 | 说明 | 工具参数设置 |
|------|------|-------------|
| **下采样** | HR 数据下采样生成 LR | `scale` + `downsample_method` 必须指定 |
| **粗网格** | LR 数据由粗网格模型直接生成 | `lr_nc_folder` 必须指定 |

---

## Step 6: 执行前 Check（关键步骤）

**在真正执行之前**，必须展示所有参数让用户确认：

```
所有参数已收集完毕，执行前请确认：

================== 处理参数确认 ==================

【输入输出】
- 数据目录: /data/ocean
- 输出目录: /output/dataset
- 文件数量: 365 个

【研究变量】
- 动态变量: chl, no3
- 掩码变量: mask
- 静态变量: lon, lat, h, mask

【数据处理】
- 超分方式: 下采样
- NaN 处理: 不允许 NaN

【下采样参数】
- 下采样倍数: 4
- 插值方法: area

【数据集划分】
- 训练集: 70%
- 验证集: 15%
- 测试集: 15%

================================================

请回复"确认执行"开始处理，或告诉我需要修改哪些参数。
```

**判断用户是否确认的标准**：
- ✅ 用户明确说："确认执行"、"确认"、"开始"、"执行"、"好的，开始吧"
- ❌ 用户只是回答了某个问题，但没说"确认执行"
- ❌ 用户提供了参数值，但没说"确认执行"

---

## Step 7: 执行

**只有**在用户明确确认后，才能调用 `ocean_preprocess_full` 执行完整流程：

```json
{
  "nc_folder": "/data/ocean",
  "output_base": "/output/dataset",
  "dyn_vars": ["chl", "no3"],
  "user_confirmed": true,
  "confirmation_token": "从阶段4返回的token",
  "mask_vars": ["mask"],
  "stat_vars": ["lon", "lat", "h", "mask"],
  "train_ratio": 0.7,
  "valid_ratio": 0.15,
  "test_ratio": 0.15,
  "scale": 4,
  "downsample_method": "area",
  "allow_nan": false
}
```

---

## 预处理完成后的后续步骤

预处理完成后，**必须**继续执行：

1. **调用 `ocean_metrics`** 计算质量指标
2. **调用 `ocean_generate_report`** 生成报告
3. **读取报告并填写分析**（替换占位符）
4. **向用户展示报告路径和关键发现**
